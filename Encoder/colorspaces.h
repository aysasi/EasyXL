#ifndef color_spaces_h
#define color_spaces_h

#include <math.h>

double linearrgb[256] = { 0.0,0.0773993808049536,0.1547987616099071,0.2321981424148607,0.3095975232198143,0.3869969040247678,0.4643962848297214,0.541795665634675,0.6191950464396285,0.696594427244582,0.7739938080495355,0.853366619794286,0.9375093676320961,1.0263028397165581,1.1198177195396248,1.218123137576901,1.3212867590962885,1.4293748641716943,1.5424524208285488,1.6605831521115912,1.7838295977526737,1.9122531710226747,2.0459142112731734,2.1848720326076734,2.3291849690663007,2.4789104166606517,2.6341048725548686,2.7948239716545027,2.9611225208346905,3.1330545310135474,3.310673247254118,3.49403117705887,3.683180117003599,3.878171177842741,4.079054808204956,4.285880816986283,4.49869839453794,4.7175561327368225,4.942502044018609,5.173583579446362,5.4108476458809065,5.654340622313782,5.904108375418154,6.160196274368713,6.4226492049772155,6.691511583186724,6.966827367964098,7.2486400736273024,7.536992781641244,7.8319281519133765,8.133488433617941,8.44171547557569,8.756650736213954,9.078335293130188,9.40680985228051,9.742114756813358,10.084289995566873,10.433375211247563,10.789409708306467,11.152432460528233,11.522482118347263,11.899597015904424,12.283815177856802,12.675174325952444,13.073711885381025,13.479464990910962,13.892470492822804,14.312764962648023,14.740384698722144,15.175365731560206,15.61774382906249,16.06755450155776,16.524833006690972,16.989614354162086,17.461933310322042,17.941824402631948,18.42932192399096,18.924459936938156,19.4272722777335,19.937792560322514,20.456054180189422,20.982090318102774,21.515933943757947,22.05761781932019,22.607174502872102,23.16463635176896,23.7300355259053,24.303403990896,24.884773521174928,25.47417570301404,26.071641937465838,26.67720344323157,27.290891259458242,27.91273624846633,28.54276909841093,29.1810203258783,29.827520278420263,30.482299137028132,31.14538691854848,31.816813478042373,32.496608511090095,33.18480155604289,33.88142199622359,34.58649906207744,35.300061833275215,36.02213924076927,36.75276006880473,37.49195295688672,38.23974640170518,38.996168759018296,39.761248245495985,40.5350129405245,41.317490787973306,42.10870959792524,42.90869704837114,43.71748068686976,44.535087932174186,45.36154607582542,46.19688228371436,47.041123597612454,47.89429693667286,48.756429098901805,49.62754676260183,50.50767648778696,51.396844717571256,52.295077779530814,53.20240188704022,54.11884314058408,55.04442752904431,55.97918093096365,56.92312911578617,57.876297745075085,58.838712373709036,59.81039845105633,60.791381322129105,61.78168622871649,62.78133831049805,63.790362606138125,64.80878405436083,65.83662749500694,66.87391767007254,67.92067922472992,68.97693670833178,70.04271457539808,71.11803718658665,72.20292880964799,73.29741362036395,74.40151570347165,75.51525905357188,76.63866757602301,77.771765087821,78.91457531846467,80.06712191080797,81.22942842189842,82.40151832380243,83.58341500441826,84.77514176827573,85.97672183732425,87.18817835170853,88.40953437053255,89.64081287261203,90.8820367572156,92.13322884479493,93.39441187770407,94.66560852090802,95.94684136268116,97.23813291529518,98.53950561569751,99.85098182617944,101.17258383503484,102.50433385720993,103.84625403494286,105.19836643839545,106.56069306627505,107.93325584644828,109.31607663654619,110.70917722456097,112.1125793294343,113.5263046016381,114.95037462374698,116.38481091100319,117.8296349118738,119.28486800860054,120.75053151774243,122.22664669071084,123.71323471429794,125.21031671119808,126.71791374052195,128.236046798305,129.76473681800812,131.30400467101296,132.85387116711036,134.41435705498233,135.98548302267884,137.56726969808733,139.15973764939758,140.76290738556003,142.3767993567383,144.00143395475695,145.63683151354263,147.28301230956092,148.93999656224685,150.6078044344309,152.28645603275965,153.97597140811115,155.6763705560055,157.38767341701103,159.10989987714441,160.84306976826744,162.58720286847833,164.34231890249845,166.10843754205516,167.88557840625936,169.67376106197938,171.47300502421032,173.28332975643892,175.10475467100494,176.93729912945741,178.78098244290814,180.63582387238012,182.50184262915258,184.37905787510218,186.26748872304017,188.16715423704636,190.0780734327988,192.00026527789984,193.93374869219957,195.8785425481143,197.83466567094302,199.80213683917935,201.7809747848207,203.7711981936743,205.77282570565916,207.7858759151058,209.8103673710523,211.84631857753692,213.8937479938887,215.9526740350138,218.02311507167963,220.10508943079608,222.19861539569328,224.30371120639708,226.4203950599014,228.54868511043793,230.68859946974314,232.84015620732188,235.00337335071012,237.17826888573305,239.36486075676143,241.56316686696596,243.77320507856797,245.9949932130886,248.2285490515952,250.47389033494488,252.7310347640266,255.0
};


/*
 
 double rgb2y (double r, double g, double b) { return +0.299f   * r +0.587f   * g +0.114f   * b; }
 double rgb2cb(double r, double g, double b) { return -0.16874f * r -0.33126f * g +0.5f     * b; }
 double rgb2cr(double r, double g, double b) { return +0.5f     * r -0.41869f * g -0.08131f * b; }
 
 */

double clamp_double(double num, double superior, double inferior) {
    if (num > superior)
        return superior;
    if (num < inferior)
        return inferior;
    return num;
}

struct pixel_cs_t{
    double c1;
    double c2;
    double c3;
};

typedef struct pixel_cs_t pixel_cs;


pixel_cs rgb2ycbcr(int r, int g, int b, int quality, pixel_cs (*sistema) (double, double, double)) { //quality = 1, 2, 4
    r *= quality;
    g *= quality;
    b *= quality;
    
    double y =      0.299       * r     +0.587   * g    +0.114   * b;
    y -= (quality << 7); // y - 128, 256, 512
    double cb =     -0.16874    * r     -0.33126 * g    +0.5     * b;
    double cr =     0.5         * r     -0.41869 * g    -0.08131 * b;
    return {y, cb, cr};
}


pixel_cs xybtransform(double linear_r, double linear_g, double linear_b) {
    double bias = 0.00379307325527544933;
    double bias_crt = 0.15595420054924863;
    
    double Lmix = 0.3 * linear_r + 0.622 * linear_g + 0.078 * linear_b;
    double Mmix = 0.23 * linear_r + 0.692 * linear_g + 0.078 * linear_b;
    double Smix = 0.24342268924547819 * linear_r + 0.20476744424496821 * linear_g + 0.55180986650955360 * linear_b;
    double Lgamma = cbrt(Lmix + bias) - bias_crt;
    double Mgamma = cbrt(Mmix + bias) - bias_crt;
    double Sgamma = cbrt(Smix + bias) - bias_crt;
    double X = (Lgamma - Mgamma) / 2;
    double Y = (Lgamma + Mgamma) / 2;
    double B = Sgamma - Mgamma;
    return {X, Y, B};
}

pixel_cs sistema256(double X, double Y, double B) {
    double xaux = 917.7928292048051 * X + 89.8910660369987;
    double yaux = 41.22609346538956 * Y;
    double baux = 58.446562111877796 * B + 109.36763436215823;
    
    return {clamp_double(xaux, 256.0, 0.0), clamp_double(yaux, 256.0, 0.0), clamp_double(baux, 256.0, 0.0)};
}

pixel_cs sistema512(double X, double Y, double B) {
    double xaux = 1842.7840335406 * X + 180.4871600429;
    double yaux = 82.7755288403 * Y;
    double baux = 117.3515286325 * B + 219.5930540919;
    
    return {clamp_double(xaux, 512.0, 0.0), clamp_double(yaux, 512.0, 0.0), clamp_double(baux, 512.0, 0.0)};
}

pixel_cs sistema1024(double X, double Y, double B) {
    double xaux = 3685.5680670813 * X + 360.9743200858;
    double yaux = 165.5510576806 * Y;
    double baux = 234.703057265 * B + 439.1861081837;
    
    return {clamp_double(xaux, 1024.0, 0.0), clamp_double(yaux, 1024.0, 0.0), clamp_double(baux, 1024.0, 0.0)};
}

pixel_cs rgb2xyb(int r, int g, int b, int quality, pixel_cs (*sistema) (double, double, double)) {
    double r1 = linearrgb[r];
    double g1 = linearrgb[g];
    double b1 = linearrgb[b];
    
    pixel_cs xyb = xybtransform(r1, g1, b1);
    xyb = sistema(xyb.c1, xyb.c2, xyb.c3);
    
    return xyb;
}

#endif
